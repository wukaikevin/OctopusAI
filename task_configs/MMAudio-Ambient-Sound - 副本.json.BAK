{
  "app_id": "MMAudio-Ambient-Sound",
  "name": "视频环境音自动生成-MMAudio",
  "description": "基于MMAudio模型，根据视频内容自动生成匹配的环境音效。支持最长60秒的视频，自动分析视频场景并生成高质量的环境音，可完美匹配视频内容。对于长视频（>8秒），采用分片处理策略，确保生成质量。支持提示词引导生成，可以指定期望的环境音类型。支持与视频原有背景音乐混合，可选择混合模式或替换模式。算力要求：单卡GPU（显存6GB以上，推荐16GB以上）",
  "author": "小夜",
  "homepage": "https://github.com/hkchengrex/MMAudio",
  "email": "none",

  "inputs": [
    {
      "label": "输入视频",
      "field_name": "video",
      "type": "file",
      "file_extensions": ["mp4", "avi", "mov", "mkv"],
      "default_value": "",
      "editable": true,
      "required": true
    },
    {
      "label": "提示词（可选，引导生成的环境音类型）",
      "field_name": "prompt",
      "type": "textarea",
      "default_value": "自然环境音,无任何人声,无音乐,无旋律。\n夏季树林环境,持续的蝉鸣声,零星鸟叫。\n仅环境噪声,不包含哼唱、吟唱、歌声、旋律性声音。",
      "editable": true,
      "required": false
    },
    {
      "label": "负面提示词（可选，避免生成的内容）",
      "field_name": "negative_prompt",
      "type": "textarea",
      "default_value": "音乐, 人声, 对话, 说话, 语音, 语言, 单词, 交谈, 聊天, 哼唱, 吟唱, 歌声, 歌唱, 旋律, 旋律性声音, 歌曲, 唱歌, 演唱, 哼, 哼歌, 口哨",
      "editable": true,
      "required": false
    },
    {
      "label": "音频混合模式",
      "field_name": "audio_mix_mode",
      "type": "select",
      "default_value": "mix",
      "editable": true,
      "required": false,
      "options": [
        { "label": "混合模式（保留原视频背景音乐）", "value": "mix" },
        { "label": "替换模式（替换原视频音频）", "value": "replace" }
      ]
    },
    {
      "label": "环境音量（混合模式下的音量比例）",
      "field_name": "ambient_volume",
      "type": "select",
      "default_value": "0.25",
      "editable": true,
      "required": false,
      "options": [
        { "label": "0.15（极低）", "value": "0.15" },
        { "label": "0.25（低，推荐）", "value": "0.25" },
        { "label": "0.35（中等）", "value": "0.35" },
        { "label": "0.5（较高）", "value": "0.5" }
      ]
    },
    {
      "label": "背景音乐音量（混合模式下原视频音频的音量比例）",
      "field_name": "bgm_volume",
      "type": "select",
      "default_value": "0.3",
      "editable": true,
      "required": false,
      "options": [
        { "label": "0.2（低）", "value": "0.2" },
        { "label": "0.3（中等，推荐）", "value": "0.3" },
        { "label": "0.4（较高）", "value": "0.4" },
        { "label": "0.5（高）", "value": "0.5" }
      ]
    },
    {
      "label": "生成步数",
      "field_name": "num_steps",
      "type": "select",
      "default_value": "25",
      "editable": true,
      "required": false,
      "options": [
        { "label": "15 步（快速，质量较低）", "value": "15" },
        { "label": "25 步（默认，平衡质量和速度）", "value": "25" },
        { "label": "50 步（慢速，高质量）", "value": "50" }
      ]
    },
    {
      "label": "引导强度",
      "field_name": "cfg_strength",
      "type": "select",
      "default_value": "4.5",
      "editable": true,
      "required": false,
      "options": [
        { "label": "3.0（低引导）", "value": "3.0" },
        { "label": "4.5（默认）", "value": "4.5" },
        { "label": "6.0（高引导）", "value": "6.0" }
      ]
    }
  ],

  "variables": {
    "work_dir": "$HOME/MMAudio",
    "model_path": "$HOME/.cache/huggingface/hub/models--hkchengrex--MMAudio"
  },

  "server_output_file": "/tmp/results/MMAudio/output.mp4",
  "server_output_dir": "/tmp/results/MMAudio",
  "model_path": "$HOME/.cache/huggingface/hub/models--hkchengrex--MMAudio",

  "installs": [
    {
      "env_name": "MMAudio",
      "python_version": "3.10",
      "cuda_version": "12.1",
      "commands": [
        "cd $HOME",
        "[ ! -d \"MMAudio\" ] && git clone https://github.com/hkchengrex/MMAudio.git || echo \"目录已存在，跳过克隆。\"",
        "cd MMAudio",
        "pip install --retries 10 --timeout 600 torch>=2.5.1 torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121",
        "# 先安装MMAudio（可能会安装huggingface_hub）",
        "pip install -e .",
        "# 然后强制锁定huggingface_hub版本到0.26.5（解决BigVGANv2兼容性问题）",
        "pip uninstall -y huggingface_hub",
        "pip install huggingface_hub==0.26.5",
        "# 验证版本",
        "python3 -c \"import huggingface_hub; print(f'✅ huggingface_hub版本: {huggingface_hub.__version__}')\"",
        "conda install -y ffmpeg=6.1.1 -c conda-forge || apt install ffmpeg -y",
        "# 复制修复脚本到工作目录（从上传的文件）",
        "cp /tmp/MMAudio/fix_bigvgan.py $HOME/MMAudio/.fix_bigvgan.py 2>/dev/null || echo '⚠️ 修复脚本将在运行时从上传位置复制'"
      ]
    }
  ],

  "batch": [
    {
      "name": "准备模型",
      "env_name": "MMAudio",
      "commands":[
         "",
        "# 预下载MMAudio所需的所有模型（large_44k_v2 variant），确保在任务运行前模型已就绪",
        "cd $HOME/MMAudio",
        "python3 << 'PYTHON_EOF'",
        "from mmaudio.eval_utils import all_model_cfg",
        "from open_clip import create_model_from_pretrained",
        "",
        "print('========== 开始下载MMAudio模型（large_44k_v2）==========')",
        "",
        "# 1. 下载主模型、VAE和Synchformer（通过download_if_needed）",
        "model = all_model_cfg['large_44k_v2']",
        "print('1. 下载主模型、VAE和Synchformer...')",
        "model.download_if_needed()",
        "print('   ✅ 主模型、VAE和Synchformer下载完成')",
        "",
        "# 2. 预下载BigVGANv2 vocoder (44k) - 使用hf_hub_download直接下载到缓存",
        "print('2. 预下载BigVGANv2 vocoder (44k)...')",
        "try:",
        "    from huggingface_hub import hf_hub_download",
        "    repo_id = 'nvidia/bigvgan_v2_44khz_128band_512x'",
        "    # 下载模型文件到HuggingFace缓存目录",
        "    hf_hub_download(repo_id=repo_id, filename='config.json', local_files_only=False)",
        "    hf_hub_download(repo_id=repo_id, filename='bigvgan_generator.pt', local_files_only=False)",
        "    print('   ✅ BigVGANv2 vocoder下载完成（文件已缓存到HuggingFace缓存目录）')",
        "except Exception as e:",
        "    print(f'   ⚠️ BigVGANv2 vocoder下载失败（将在运行时自动下载）: {e}')",
        "",
        "# 3. 预下载CLIP模型 - 从HuggingFace下载",
        "print('3. 预下载CLIP模型...')",
        "try:",
        "    clip_model = create_model_from_pretrained('hf-hub:apple/DFN5B-CLIP-ViT-H-14-384', return_transform=False)",
        "    print('   ✅ CLIP模型下载完成')",
        "except Exception as e:",
        "    print(f'   ⚠️ CLIP模型下载失败（将在运行时自动下载）: {e}')",
        "",
        "print('========== MMAudio所有模型下载完成 ==========')",
        "PYTHON_EOF",
        ""
      ]
    },
    {
      "name": "生成环境音（支持长视频分片处理）",
      "env_name": "MMAudio",
      "commands": [
        "cd {work_dir}",
        "# 应用BigVGANv2运行时修复（双重保障）",
        "# 确保修复脚本已复制到工作目录",
        "if [[ ! -f \"$HOME/MMAudio/.fix_bigvgan.py\" ]]; then",
        "  cp /tmp/MMAudio/fix_bigvgan.py $HOME/MMAudio/.fix_bigvgan.py 2>/dev/null || echo '⚠️ 修复脚本未找到，尝试直接修复...'",
        "fi",
        "if [[ -f \"$HOME/MMAudio/.fix_bigvgan.py\" ]]; then",
        "  python3 \"$HOME/MMAudio/.fix_bigvgan.py\" || echo '⚠️ 修复脚本执行失败，继续执行...'",
        "else",
        "  echo '⚠️ 修复脚本未找到，尝试直接修复...'",
        "  python3 << 'DIRECT_FIX_EOF'",
        "from huggingface_hub import PyTorchModelHubMixin",
        "_orig = PyTorchModelHubMixin.from_pretrained",
        "class _Patched:",
        "    @classmethod",
        "    def _patched(cls, *a, proxies=None, resume_download=True, **kw):",
        "        return _orig(cls, *a, proxies=proxies or {}, resume_download=resume_download, **kw)",
        "PyTorchModelHubMixin.from_pretrained = _Patched._patched",
        "print('✅ 已应用BigVGANv2运行时修复补丁（直接修复）')",
        "DIRECT_FIX_EOF",
        "fi",
        "export PYTHONPATH=\"$HOME/MMAudio:$PYTHONPATH\"",
        "",
        "OUTPUT_DIR=\"/tmp/results/MMAudio\"",
        "mkdir -p $OUTPUT_DIR",
        "",
        "# 处理输入视频路径",
        "VIDEO=\"{video}\"",
        "VIDEO=$(echo \"$VIDEO\" | sed 's|^file://||')",
        "if [[ ! -f \"$VIDEO\" ]]; then",
        "  echo \"错误：未找到视频文件: $VIDEO\"",
        "  exit 1",
        "fi",
        "",
        "# 获取视频时长",
        "VIDEO_DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 \"$VIDEO\" 2>/dev/null | head -n 1)",
        "if [[ -z \"$VIDEO_DURATION\" ]]; then",
        "  echo \"警告：无法获取视频时长，尝试处理整个视频\"",
        "  VIDEO_DURATION=60",
        "fi",
        "echo \"视频时长: ${VIDEO_DURATION} 秒\"",
        "",
        "# 设置参数",
        "PROMPT=\"{prompt}\"",
        "NEGATIVE_PROMPT=\"{negative_prompt}\"",
        "if [[ -z \"$NEGATIVE_PROMPT\" ]]; then NEGATIVE_PROMPT=\"音乐, 人声, 对话, 说话, 语音, 语言, 单词, 交谈, 聊天, 哼唱, 吟唱, 歌声, 歌唱, 旋律, 旋律性声音, 歌曲, 唱歌, 演唱, 哼, 哼歌, 口哨\"; fi",
        "NUM_STEPS={num_steps}",
        "if [[ -z \"$NUM_STEPS\" ]]; then NUM_STEPS=25; fi",
        "CFG_STRENGTH={cfg_strength}",
        "if [[ -z \"$CFG_STRENGTH\" ]]; then CFG_STRENGTH=4.5; fi",
        "",
        "# 判断是否需要分片处理（>10秒才分片，10秒以内直接处理）",
        "SEGMENT_DURATION=8.0",
        "CHUNK_THRESHOLD=10.0",
        "NEED_CHUNKING=false",
        "if (($(echo \"$VIDEO_DURATION > $CHUNK_THRESHOLD\" | bc -l 2>/dev/null || echo 0) )); then",
        "  NEED_CHUNKING=true",
        "  echo \"视频时长超过${CHUNK_THRESHOLD}秒,启用分段处理(每段 ${SEGMENT_DURATION}秒)\"",
        "else",
        "  echo \"视频时长 ≤ ${CHUNK_THRESHOLD}秒,单次生成模式\"",
        "fi",
        "",
        "if [[ \"$NEED_CHUNKING\" == \"true\" ]]; then",
        "  echo \"========== 开始分片处理长视频 ==========\"",
        "  ",
        "  # 计算分片数量",
        "  NUM_SEGMENTS=$(python3 -c \"import math; print(math.ceil($VIDEO_DURATION / $SEGMENT_DURATION))\")",
        "  echo \"将视频分成 ${NUM_SEGMENTS} 个片段，每段 ${SEGMENT_DURATION} 秒\"",
        "  ",
        "  # 创建临时目录",
        "  TEMP_DIR=\"$OUTPUT_DIR/temp_segments\"",
        "  rm -rf \"$TEMP_DIR\"",
        "  mkdir -p \"$TEMP_DIR\"",
        "  ",
        "  # 分片处理",
        "  AUDIO_SEGMENTS=()",
        "  for i in $(seq 0 $((NUM_SEGMENTS - 1))); do",
        "    START_TIME=$(python3 -c \"print($i * $SEGMENT_DURATION)\")",
        "    END_TIME=$(python3 -c \"print(min(($i + 1) * $SEGMENT_DURATION, $VIDEO_DURATION))\")",
        "    CURRENT_DURATION=$(python3 -c \"print($END_TIME - $START_TIME)\")",
        "    ",
        "    echo \"处理片段 $((i+1))/${NUM_SEGMENTS}: ${START_TIME}秒 - ${END_TIME}秒\"",
        "    ",
        "    # 提取视频片段",
        "    SEGMENT_VIDEO=\"$TEMP_DIR/segment_${i}.mp4\"",
        "    ffmpeg -y -i \"$VIDEO\" -ss \"$START_TIME\" -t \"$CURRENT_DURATION\" -c:v copy -c:a copy \"$SEGMENT_VIDEO\" 2>/dev/null",
        "    ",
        "    # 为每个片段生成音频",
        "    SEGMENT_AUDIO=\"$TEMP_DIR/segment_${i}.flac\"",
        "    if [[ ! -f \"$HOME/MMAudio/.fix_bigvgan.py\" ]]; then",
        "      cp /tmp/MMAudio/fix_bigvgan.py $HOME/MMAudio/.fix_bigvgan.py 2>/dev/null || true",
        "    fi",
        "    if [[ -f \"$HOME/MMAudio/.fix_bigvgan.py\" ]]; then",
        "      python3 \"$HOME/MMAudio/.fix_bigvgan.py\"",
        "    else",
        "      python3 << 'DIRECT_FIX_EOF'",
        "from huggingface_hub import PyTorchModelHubMixin",
        "_orig = PyTorchModelHubMixin.from_pretrained",
        "class _Patched:",
        "    @classmethod",
        "    def _patched(cls, *a, proxies=None, resume_download=True, **kw):",
        "        return _orig(cls, *a, proxies=proxies or {}, resume_download=resume_download, **kw)",
        "PyTorchModelHubMixin.from_pretrained = _Patched._patched",
        "DIRECT_FIX_EOF",
        "    fi && python demo.py \\",
        "      --variant large_44k_v2 \\",
        "      --video \"$SEGMENT_VIDEO\" \\",
        "      --prompt \"$PROMPT\" \\",
        "      --negative_prompt \"$NEGATIVE_PROMPT\" \\",
        "      --duration $CURRENT_DURATION \\",
        "      --cfg_strength $CFG_STRENGTH \\",
        "      --num_steps $NUM_STEPS \\",
        "      --seed $((42 + i)) \\",
        "      --output \"$TEMP_DIR\" \\",
        "      --skip_video_composite",
        "    ",
        "    # 查找生成的音频文件",
        "    if [[ -f \"$SEGMENT_AUDIO\" ]]; then",
        "      AUDIO_SEGMENTS+=(\"$SEGMENT_AUDIO\")",
        "      echo \"✅ 片段 $((i+1)) 音频生成成功\"",
        "    else",
        "      # 尝试查找以segment_${i}开头的flac文件",
        "      FOUND_AUDIO=$(find \"$TEMP_DIR\" -name \"segment_${i}*.flac\" | head -n 1)",
        "      if [[ -n \"$FOUND_AUDIO\" && -f \"$FOUND_AUDIO\" ]]; then",
        "        AUDIO_SEGMENTS+=(\"$FOUND_AUDIO\")",
        "        echo \"✅ 片段 $((i+1)) 音频生成成功（找到文件: $FOUND_AUDIO）\"",
        "      else",
        "        echo \"⚠️ 警告：片段 $((i+1)) 音频生成失败\"",
        "      fi",
        "    fi",
        "  done",
        "  ",
        "  # 合并所有音频片段",
        "  if [[ ${#AUDIO_SEGMENTS[@]} -eq 0 ]]; then",
        "    echo \"错误：没有成功生成任何音频片段\"",
        "    exit 1",
        "  fi",
        "  ",
        "  echo \"========== 合并音频片段 ==========\"",
        "  CONCAT_FILE=\"$TEMP_DIR/concat_list.txt\"",
        "  rm -f \"$CONCAT_FILE\"",
        "  for audio in \"${AUDIO_SEGMENTS[@]}\"; do",
        "    echo \"file '$(realpath \"$audio\")'\" >> \"$CONCAT_FILE\"",
        "  done",
        "  ",
        "  MERGED_AUDIO=\"$TEMP_DIR/merged_audio.flac\"",
        "  ffmpeg -y -f concat -safe 0 -i \"$CONCAT_FILE\" -c copy \"$MERGED_AUDIO\" 2>/dev/null || \\",
        "  ffmpeg -y -i \"$(printf \"%s|\" \"${AUDIO_SEGMENTS[@]}\" | sed 's/|$//')\" -filter_complex \"concat=n=${#AUDIO_SEGMENTS[@]}:v=0:a=1\" \"$MERGED_AUDIO\" 2>/dev/null",
        "  ",
        "  if [[ ! -f \"$MERGED_AUDIO\" ]]; then",
        "    echo \"错误：音频合并失败\"",
        "    exit 1",
        "  fi",
        "  ",
        "  GENERATED_AUDIO=\"$MERGED_AUDIO\"",
        "else",
        "  echo \"========== 单次处理模式（≤10秒）==========\"",
        "  ",
        "  # 直接处理整个视频（10秒以内，质量可接受）",
        "  ACTUAL_DURATION=$VIDEO_DURATION",
        "  GENERATED_AUDIO=\"$OUTPUT_DIR/generated_audio.flac\"",
        "  ",
        "  if [[ ! -f \"$HOME/MMAudio/.fix_bigvgan.py\" ]]; then",
        "    cp /tmp/MMAudio/fix_bigvgan.py $HOME/MMAudio/.fix_bigvgan.py 2>/dev/null || true",
        "  fi",
        "  if [[ -f \"$HOME/MMAudio/.fix_bigvgan.py\" ]]; then",
        "    python3 \"$HOME/MMAudio/.fix_bigvgan.py\"",
        "  else",
        "    python3 << 'DIRECT_FIX_EOF'",
        "from huggingface_hub import PyTorchModelHubMixin",
        "_orig = PyTorchModelHubMixin.from_pretrained",
        "class _Patched:",
        "    @classmethod",
        "    def _patched(cls, *a, proxies=None, resume_download=True, **kw):",
        "        return _orig(cls, *a, proxies=proxies or {}, resume_download=resume_download, **kw)",
        "PyTorchModelHubMixin.from_pretrained = _Patched._patched",
        "DIRECT_FIX_EOF",
        "  fi && python demo.py \\",
        "    --variant large_44k_v2 \\",
        "    --video \"$VIDEO\" \\",
        "    --prompt \"$PROMPT\" \\",
        "    --negative_prompt \"$NEGATIVE_PROMPT\" \\",
        "    --duration $VIDEO_DURATION \\",
        "    --cfg_strength $CFG_STRENGTH \\",
        "    --num_steps $NUM_STEPS \\",
        "    --seed 42 \\",
        "    --output \"$OUTPUT_DIR\" \\",
        "    --skip_video_composite",
        "  ",
        "  # 查找生成的音频文件",
        "  VIDEO_BASENAME=$(basename \"$VIDEO\" .mp4 | sed 's/\\.avi$//' | sed 's/\\.mov$//' | sed 's/\\.mkv$//')",
        "  if [[ ! -f \"$GENERATED_AUDIO\" ]]; then",
        "    # 尝试查找生成的音频文件",
        "    FOUND_AUDIO=$(find \"$OUTPUT_DIR\" -name \"${VIDEO_BASENAME}*.flac\" | head -n 1)",
        "    if [[ -n \"$FOUND_AUDIO\" && -f \"$FOUND_AUDIO\" ]]; then",
        "      GENERATED_AUDIO=\"$FOUND_AUDIO\"",
        "    else",
        "      FOUND_AUDIO=$(find \"$OUTPUT_DIR\" -name \"*.flac\" | head -n 1)",
        "      if [[ -n \"$FOUND_AUDIO\" && -f \"$FOUND_AUDIO\" ]]; then",
        "        GENERATED_AUDIO=\"$FOUND_AUDIO\"",
        "      else",
        "        echo \"错误：未找到生成的音频文件\"",
        "        exit 1",
        "      fi",
        "    fi",
        "  fi",
        "fi",
        "",
        "# 合并音频到视频",
        "echo \"========== 合并音频到视频 ==========\"",
        "OUTPUT_VIDEO=\"$OUTPUT_DIR/output.mp4\"",
        "",
        "# 获取混合模式和音量参数",
        "MIX_MODE=\"{audio_mix_mode}\"",
        "if [[ -z \"$MIX_MODE\" ]]; then MIX_MODE=\"mix\"; fi",
        "AMBIENT_VOL=\"{ambient_volume}\"",
        "if [[ -z \"$AMBIENT_VOL\" ]]; then AMBIENT_VOL=\"0.25\"; fi",
        "BGM_VOL=\"{bgm_volume}\"",
        "if [[ -z \"$BGM_VOL\" ]]; then BGM_VOL=\"0.3\"; fi",
        "",
        "# 检查视频是否已有音频流",
        "HAS_AUDIO=$(ffprobe -v error -select_streams a -show_entries stream=codec_type -of csv=p=0 \"$VIDEO\" 2>/dev/null | head -n 1)",
        "",
        "if [[ \"$MIX_MODE\" == \"mix\" && -n \"$HAS_AUDIO\" ]]; then",
        "  echo \"混合模式：将环境音与背景音乐混合\"",
        "  ",
        "  # 提取原视频的背景音乐",
        "  ORIGINAL_BGM=\"$OUTPUT_DIR/original_bgm.wav\"",
        "  ffmpeg -y -i \"$VIDEO\" -vn -ac 2 -ar 44100 -c:a pcm_s16le \"$ORIGINAL_BGM\" 2>/dev/null",
        "  ",
        "  if [[ -f \"$ORIGINAL_BGM\" ]]; then",
        "    # 混合背景音乐和环境音",
        "    # 使用 amix 滤镜进行混合，dropout_transition 防止音频切换时的爆音",
        "    MIXED_AUDIO=\"$OUTPUT_DIR/mixed_audio.wav\"",
        "    ffmpeg -y -i \"$GENERATED_AUDIO\" -i \"$ORIGINAL_BGM\" \\",
        "      -filter_complex \"[0:a]volume=$AMBIENT_VOL[ambient];[1:a]volume=$BGM_VOL[bgm];[ambient][bgm]amix=inputs=2:duration=longest:dropout_transition=2[mixed]\" \\",
        "      -map \"[mixed]\" -c:a pcm_s16le \"$MIXED_AUDIO\" 2>/dev/null",
        "    ",
        "    if [[ -f \"$MIXED_AUDIO\" ]]; then",
        "      # 合并混合后的音频到视频",
        "      ffmpeg -y -i \"$VIDEO\" -i \"$MIXED_AUDIO\" -c:v copy -c:a aac -b:a 192k -map 0:v:0 -map 1:a:0 -shortest \"$OUTPUT_VIDEO\" 2>/dev/null",
        "      echo \"✅ 环境音与背景音乐混合完成\"",
        "      rm -f \"$ORIGINAL_BGM\" \"$MIXED_AUDIO\"",
        "    else",
        "      echo \"⚠️ 警告：音频混合失败，使用替换模式\"",
        "      MIX_MODE=\"replace\"",
        "    fi",
        "  else",
        "    echo \"⚠️ 警告：无法提取原视频音频，使用替换模式\"",
        "    MIX_MODE=\"replace\"",
        "  fi",
        "fi",
        "",
        "if [[ \"$MIX_MODE\" == \"replace\" || -z \"$HAS_AUDIO\" ]]; then",
        "  echo \"替换模式：用环境音替换原视频音频\"",
        "  if [[ -n \"$HAS_AUDIO\" ]]; then",
        "    ffmpeg -y -i \"$VIDEO\" -i \"$GENERATED_AUDIO\" -c:v copy -c:a aac -b:a 192k -map 0:v:0 -map 1:a:0 -shortest \"$OUTPUT_VIDEO\" 2>/dev/null",
        "  else",
        "    ffmpeg -y -i \"$VIDEO\" -i \"$GENERATED_AUDIO\" -c:v copy -c:a aac -b:a 192k -shortest \"$OUTPUT_VIDEO\" 2>/dev/null",
        "  fi",
        "  echo \"✅ 环境音已替换原视频音频\"",
        "fi",
        "",
        "if [[ ! -f \"$OUTPUT_VIDEO\" ]]; then",
        "  echo \"错误：视频音频合并失败\"",
        "  exit 1",
        "fi",
        "",
        "# 清理临时文件",
        "rm -rf \"$TEMP_DIR\" 2>/dev/null || true",
        "",
        "echo \"✅ 环境音生成完成: $OUTPUT_VIDEO\""
      ]
    }
  ],
  
  "endpoint": "echo \"{server_output_file}\"",
  "uploads": [
    {
      "source_path": "MMAudio/fix_bigvgan.py",
      "server_path": "/tmp/MMAudio/fix_bigvgan.py"
    }
  ]
}
