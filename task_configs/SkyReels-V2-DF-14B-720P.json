{
  "app_id": "SkyReels-V2-DF-14B-720P",
  "name": "长视频生成-SkyReels-V2进阶版",
  "description": "基于SkyReels-V2-DF-14B-720P模型的文本/图像生成长视频工具，支持文生视频和图生视频。用户可以自定义视频时长（10/15/30/60秒）、提示词、参考图像和背景音乐。支持24/30/60 FPS多种帧率选择，自动检测GPU数量进行多卡加速。新增视频高清放大功能，支持2倍/4倍放大，可显著提升视频分辨率。输出720P分辨率，支持分片推理生成高质量长视频。算力要求：H100-80G或等效算力以上，支持多卡加速计算。（单卡H100跑10秒视频约1小时）",
  "author": "小夜",
  "homepage": "https://github.com/h2632785869-ctrl",
  "email": "none",

  "inputs": [
    {
      "label": "视频时长(秒)",
      "field_name": "duration",
      "type": "select",
      "default_value": "10",
      "editable": true,
      "required": true,
      "options": [
        { "label": "10 秒", "value": "10" },
        { "label": "15 秒", "value": "15" },
        { "label": "30 秒", "value": "30" },
        { "label": "60 秒", "value": "60" }
      ]
    },
    {
      "label": "提示词（电影镜头语言，可选）",
      "field_name": "prompt",
      "type": "textarea",
      "default_value": "",
      "editable": true,
      "required": false
    },
    {
      "label": "参考图像（可选）",
      "field_name": "image",
      "type": "file",
      "file_extensions": ["png", "jpg", "jpeg"],
      "default_value": "",
      "editable": true,
      "required": false
    },
    {
      "label": "附加音频（可选，作为背景音乐）",
      "field_name": "audio",
      "type": "file",
      "file_extensions": ["mp3", "wav", "m4a", "flac", "aac", "mp4"],
      "default_value": "",
      "editable": true,
      "required": false
    },
    {
      "label": "视频帧率 (FPS)",
      "field_name": "fps",
      "type": "select",
      "default_value": "24",
      "editable": true,
      "required": false,
      "options": [
        { "label": "24 FPS（电影标准，H100单卡）", "value": "24" },
        { "label": "30 FPS（电视标准，建议2卡）", "value": "30" },
        { "label": "60 FPS（高帧率，建议4-6卡）", "value": "60" }
      ]
    },
    {
      "label": "启用视频高清放大",
      "field_name": "enable_upscale",
      "type": "select",
      "default_value": "off",
      "editable": true,
      "required": false,
      "options": [
        { "label": "关闭", "value": "off" },
        { "label": "开启", "value": "on" }
      ]
    },
    {
      "label": "放大倍数",
      "field_name": "zoom_factor",
      "type": "select",
      "default_value": "2",
      "editable": true,
      "required": false,
      "options": [
        { "label": "2倍", "value": "2" },
        { "label": "4倍", "value": "4" }
      ]
    }
  ],

  "variables": {
    "work_dir": "$HOME/SkyReels-V2-DF-14B-720P",
    "model_path": "$HOME/.cache/SkyReels-V2-DF-14B-720P"
  },

  "server_output_file": "/tmp/results/SkyReels-V2/output.mp4",
  "server_output_dir": "/tmp/results/SkyReels-V2",
  "model_path": "$HOME/.cache/SkyReels-V2-DF-14B-720P",

  "installs": [
    {
      "env_name": "SkyReels-V2-DF-14B-720P-H100-sync",
      "python_version": "3.12.9",
      "cuda_version": "12.8",
      "commands": [
        "rm -rf {work_dir}",
        "conda install -y ffmpeg=7.1.1 -c conda-forge",
        "git clone https://github.com/SkyworkAI/SkyReels-V2 {work_dir}",
        "cd {work_dir}",
        "pip install https://github.com/Dao-AILab/flash-attention/releases/download/v2.8.2/flash_attn-2.8.2+cu12torch2.7cxx11abiFALSE-cp312-cp312-linux_x86_64.whl",
        "pip install -r requirements.txt",
        "pip install huggingface_hub[cli]",
        "huggingface-cli download Skywork/SkyReels-V2-DF-14B-720P --local-dir {model_path}",
        "pip install --retries 10 --timeout 600 torch==2.7.0 torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128",
        "pip install opencv-python-headless decord moviepy==1.0.3 imageio-ffmpeg imageio[ffmpeg]"
      ]
    },
    {
      "env_name": "video-High-Quality",
      "python_version": "3.11.14",
      "cuda_version": "12.8",
      "commands": [
        "cd $HOME",
        "pwd",
        "find ./ -maxdepth 1 -type d ! -name \"miniconda*\" ! -name \".*\"  ! -name \"SkyReels-V2-DF-14B-720P\" -exec rm -rf {} +",
        "wget --tries=10 --timeout=60 --retry-connrefused https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb || (sleep 5 && wget --tries=10 --timeout=60 --retry-connrefused https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb)",
        "dpkg -i cuda-keyring_1.1-1_all.deb",
        "apt-get update",
        "apt-get install cuda-toolkit-12-8 -y",
        "apt install ffmpeg -y",
        "apt install git-lfs -y",
        "git lfs install",
        "[ ! -d \"Video-High-Quality\" ] && git clone https://github.com/jiang926/Video-High-Quality.git || echo \"目录已存在，跳过克隆。\"",
        "cd Video-High-Quality",
        "pip install --retries 10 --timeout 600 torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128",
        "rm -rf requirements.txt",
        "pip install -e .",
        "pip install imageio tqdm huggingface_hub modelscope transformers sentencepiece ftfy imageio-ffmpeg",
        "cd $HOME",
        "[ ! -d \"Block-Sparse-Attention\" ] && git clone https://github.com/mit-han-lab/Block-Sparse-Attention.git || echo \"目录已存在，跳过克隆。\"",
        "cd Block-Sparse-Attention",
        "pip install packaging",
        "pip install ninja",
        "pip install $HOME/Video-High-Quality/packages/block_sparse_attn-0.0.1-cp311-cp311-linux_x86_64.whl || pip install https://github.com/jiang926/Video-High-Quality/raw/main/packages/block_sparse_attn-0.0.1-cp311-cp311-linux_x86_64.whl",
        "cd $HOME",
        "cd Video-High-Quality/examples/WanVSR",
        "echo \"-5-------------------\" ",
        "pwd",
        "rm -rf FlashVSR-v1.1",
        "[ ! -d \"FlashVSR-v1.1\" ] && git lfs clone https://huggingface.co/JunhaoZhuang/FlashVSR-v1.1 || echo \"目录已存在，跳过克隆。\"",
        "echo \"-1-------------------\" "
      ]
    }
  ],

  "batch": [
    {
      "name": "生成视频（自动检测GPU数量）",
      "env_name": "SkyReels-V2-DF-14B-720P-H100-sync",
      "commands": [
        "cd {work_dir}",
        "# 定义工作输出目录（用于生成和处理）",
        "OUTPUT_DIR=\"/tmp/results/SkyReels-V2\"",
        "mkdir -p $OUTPUT_DIR",
        "",
        "# 获取帧率参数（默认为24）",
        "FPS={fps}",
        "if [[ -z \"$FPS\" || \"$FPS\" == \"\" ]]; then FPS=24; fi",
        "echo \"使用帧率: ${FPS} FPS\"",
        "",
        "# 根据时长和帧率动态计算帧数",
        "IMAGE={image}",
        "if [[ \"{duration}\" == \"10\" ]]; then num_frames=$((10 * FPS));",
        "elif [[ \"{duration}\" == \"15\" ]]; then num_frames=$((15 * FPS));",
        "elif [[ \"{duration}\" == \"30\" ]]; then num_frames=$((30 * FPS));",
        "elif [[ \"{duration}\" == \"60\" ]]; then num_frames=$((60 * FPS));",
        "else echo '错误：时长必须为10/15/30/60秒'; exit 1; fi",
        "",
        "# 检查 GPU 数量并给出建议",
        "GPU_COUNT=$(python -c \"import torch; print(torch.cuda.device_count())\")",
        "if [[ $FPS -eq 60 && $GPU_COUNT -lt 4 ]]; then",
        "  echo \"⚠️ 警告：60 FPS 建议使用至少4张H100卡，当前只有 ${GPU_COUNT} 张，可能显存不足\"",
        "elif [[ $FPS -eq 30 && $GPU_COUNT -lt 2 ]]; then",
        "  echo \"⚠️ 警告：30 FPS 建议使用至少2张H100卡，当前只有 ${GPU_COUNT} 张，可能显存不足\"",
        "fi",
        "",
        "echo \"视频参数: 时长={duration}秒, 帧率=${FPS}fps, 总帧数=${num_frames}帧, GPU数量=${GPU_COUNT}张\"",

        "IMAGE_PARAM=\"\"",
        "if [[ -n \"$IMAGE\" ]]; then IMAGE_PARAM=\"--image $IMAGE\"; fi",

        "# 处理提示词：如果为空，根据是否有图像使用不同的默认提示词",
        "PROMPT=\"{prompt}\"",
        "if [[ -z \"$PROMPT\" ]]; then",
        "  if [[ -z \"$IMAGE\" ]]; then",
        "    PROMPT=\"一个充满活力的动态场景，画面流畅自然，细节丰富，高质量视频，流畅的动画效果，自然的运动轨迹，细腻的画面质感\"",
        "    echo \"提示词为空且未提供图像，使用文生视频默认提示词\"",
        "  else",
        "    PROMPT=\"画面自然流畅，镜头轻微运动，场景动态自然，细节丰富，高质量视频，流畅的动画效果，自然的运动轨迹，细腻的画面质感，专业级视频质量\"",
        "    echo \"提示词为空但提供了图像，使用图生视频默认提示词\"",
        "  fi",
        "fi",

        "# 修复超长文件名：将输出文件名改为 {timestamp}.mp4",
        "sed -i \"s/video_out_file = f\\\".*_{current_time}\\\\.mp4\\\"/video_out_file = f\\\"{current_time}.mp4\\\"/\" generate_video_df.py",

        "echo \"开始生成视频：720P，${FPS}fps，同步推理，base_num_frames=77，steps=30，offload 模式\"",
        "",
        "# 生成随机种子（基于时间戳），确保每次生成都不同",
        "RANDOM_SEED=$(python3 -c \"import random, time; random.seed(time.time()); print(random.randint(1, 4294967294))\" 2>/dev/null || echo $((RANDOM * RANDOM + $(date +%s))))",
        "",
        "PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True torchrun --nproc_per_node=$(python -c \"import torch; print(torch.cuda.device_count())\") generate_video_df.py \\",
        "  --model_id {model_path} \\",
        "  --resolution 720P \\",
        "  --num_frames ${num_frames} \\",
        "  --base_num_frames 77 \\",
        "  --overlap_history 17 \\",
        "  --fps ${FPS} \\",
        "  --guidance_scale 6.0 \\",
        "  --addnoise_condition 20 \\",
        "  --inference_steps 30 \\",
        "  --use_ret_steps \\",
        "  --seed $RANDOM_SEED \\",
        "  --prompt \"$PROMPT\" \\",
        "  --offload \\",
        "  --use_usp \\",
        "  --outdir $OUTPUT_DIR \\",
        "  $IMAGE_PARAM",
        "",
        "# 处理附加音频（如果提供）",
        "cd $OUTPUT_DIR",
        "# 强制创建目录（确保目录存在）",
        "mkdir -p $OUTPUT_DIR",
        "",
        "# 调试信息：检查音频参数",
        "echo \"========== 音频处理调试信息 ==========\"",
        "AUDIO_RAW=\"{audio}\"",
        "echo \"原始音频参数: $AUDIO_RAW\"",
        "",
        "# 处理音频路径：移除 file:// 前缀，处理特殊字符",
        "AUDIO=\"$AUDIO_RAW\"",
        "AUDIO=$(echo \"$AUDIO\" | sed 's|^file://||')",
        "echo \"处理后的音频路径: $AUDIO\"",
        "",
        "# 尝试多种方式查找音频文件（优先使用最新上传的）",
        "AUDIO_FILE=\"\"",
        "if [[ -n \"$AUDIO\" && \"$AUDIO\" != \"\" ]]; then",
        "  # 方式1：直接路径（优先使用传入的路径，这应该是本次上传的文件）",
        "  if [[ -f \"$AUDIO\" ]]; then",
        "    AUDIO_FILE=\"$AUDIO\"",
        "    echo \"✅ 找到音频文件（直接路径，本次上传）: $AUDIO_FILE\"",
        "  # 方式2：在 /tmp/uploads 目录查找（上传文件通常在这里）",
        "  elif [[ -f \"/tmp/uploads/$(basename \"$AUDIO\")\" ]]; then",
        "    AUDIO_FILE=\"/tmp/uploads/$(basename \"$AUDIO\")\"",
        "    echo \"✅ 找到音频文件（/tmp/uploads，按文件名匹配）: $AUDIO_FILE\"",
        "  # 方式3：查找 /tmp/uploads 目录下最新的音频文件（按修改时间排序，只选择最新的）",
        "  else",
        "    echo \"⚠️ 无法通过路径找到音频文件，查找 /tmp/uploads 目录下最新的音频文件...\"",
        "    # 查找所有音频文件，按修改时间排序（-t 参数：最新的在前），选择第一个（最新的）",
        "    latest_audio=\"\"",
        "    for ext in wav mp3 m4a flac aac mp4; do",
        "      # 使用 ls -t 按修改时间排序，选择第一个（最新的）",
        "      found_file=$(ls -t /tmp/uploads/*.$ext 2>/dev/null | head -n 1)",
        "      if [[ -n \"$found_file\" && -f \"$found_file\" ]]; then",
        "        # 如果还没找到文件，或者这个文件比之前的更新，则使用这个文件",
        "        if [[ -z \"$latest_audio\" ]]; then",
        "          latest_audio=\"$found_file\"",
        "        else",
        "          # 比较文件修改时间，选择更新的",
        "          if [[ \"$found_file\" -nt \"$latest_audio\" ]]; then",
        "            latest_audio=\"$found_file\"",
        "          fi",
        "        fi",
        "      fi",
        "    done",
        "    ",
        "    if [[ -n \"$latest_audio\" && -f \"$latest_audio\" ]]; then",
        "      AUDIO_FILE=\"$latest_audio\"",
        "      echo \"✅ 找到最新的音频文件: $AUDIO_FILE\"",
        "      echo \"   文件修改时间: $(stat -c %y \"$AUDIO_FILE\" 2>/dev/null || date -r \"$AUDIO_FILE\" 2>/dev/null || echo 'N/A')\"",
        "    else",
        "      echo \"⚠️ 警告：无法找到音频文件，尝试的路径:\"",
        "      echo \"  - $AUDIO\"",
        "      echo \"  - /tmp/uploads/$(basename \"$AUDIO\" 2>/dev/null || echo 'N/A')\"",
        "      echo \"  - /tmp/uploads/*.{wav,mp3,m4a,flac,aac,mp4}\"",
        "    fi",
        "  fi",
        "fi",
        "",
        "# 如果找到音频文件，进行处理",
        "if [[ -n \"$AUDIO_FILE\" && -f \"$AUDIO_FILE\" ]]; then",
        "  echo \"========== 开始处理音频 ==========\"",
        "  echo \"音频文件: $AUDIO_FILE\"",
        "  ",
        "  # 找到最新生成的视频文件",
        "  LATEST_VIDEO=$(ls -t *.mp4 2>/dev/null | head -n 1)",
        "  if [[ -z \"$LATEST_VIDEO\" ]]; then",
        "    echo \"错误：未找到生成的视频文件\"",
        "    exit 1",
        "  fi",
        "  echo \"视频文件: $LATEST_VIDEO\"",
        "  ",
        "  # 获取视频的实际时长",
        "  VIDEO_DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 \"$LATEST_VIDEO\" 2>/dev/null | head -n 1)",
        "  if [[ -z \"$VIDEO_DURATION\" ]]; then",
        "    VIDEO_DURATION={duration}",
        "  fi",
        "  ",
        "  echo \"视频时长: ${VIDEO_DURATION} 秒，开始处理音频以匹配视频长度...\"",
        "  ",
        "  # 处理音频：循环或裁剪以匹配视频时长",
        "  AUDIO_TEMP=\"temp_audio.wav\"",
        "  echo \"步骤1: 转换音频格式...\"",
        "  if ! ffmpeg -y -i \"$AUDIO_FILE\" -ar 44100 -ac 2 \"$AUDIO_TEMP\" 2>/dev/null; then",
        "    if ! ffmpeg -y -i \"$AUDIO_FILE\" -ar 44100 -ac 2 -c:a pcm_s16le \"$AUDIO_TEMP\" 2>/dev/null; then",
        "      echo \"错误：无法转换音频文件，尝试继续处理...\"",
        "      # 如果转换失败，尝试直接使用原文件",
        "      cp \"$AUDIO_FILE\" \"$AUDIO_TEMP\" 2>/dev/null || true",
        "    fi",
        "  fi",
        "  ",
        "  if [[ -f \"$AUDIO_TEMP\" ]]; then",
        "    echo \"步骤2: 创建匹配视频时长的音频（循环播放）...\"",
        "    # 创建匹配视频时长的音频（循环播放）",
        "    AUDIO_LOOPED=\"audio_looped.wav\"",
        "    if ! ffmpeg -y -stream_loop -1 -i \"$AUDIO_TEMP\" -t \"$VIDEO_DURATION\" -c:a pcm_s16le \"$AUDIO_LOOPED\" 2>/dev/null; then",
        "      if ! ffmpeg -y -i \"$AUDIO_TEMP\" -af \"aloop=loop=-1:size=2e+09\" -t \"$VIDEO_DURATION\" -c:a pcm_s16le \"$AUDIO_LOOPED\" 2>/dev/null; then",
        "        echo \"警告：音频循环处理失败，尝试直接裁剪前 ${VIDEO_DURATION} 秒\"",
        "        ffmpeg -y -i \"$AUDIO_TEMP\" -t \"$VIDEO_DURATION\" -c:a pcm_s16le \"$AUDIO_LOOPED\" 2>/dev/null || true",
        "      fi",
        "    fi",
        "    ",
        "    if [[ -f \"$AUDIO_LOOPED\" ]]; then",
        "      echo \"步骤3: 合并视频和音频...\"",
        "      # 合并视频和音频",
        "      OUTPUT_WITH_AUDIO=\"video_with_audio.mp4\"",
        "      if ffmpeg -y -i \"$LATEST_VIDEO\" -i \"$AUDIO_LOOPED\" -c:v copy -c:a aac -b:a 192k -shortest \"$OUTPUT_WITH_AUDIO\" 2>/dev/null; then",
        "        # 替换原视频",
        "        mv \"$OUTPUT_WITH_AUDIO\" \"$LATEST_VIDEO\"",
        "        echo \"✅ 音频已成功添加到视频中\"",
        "      else",
        "        echo \"⚠️ 警告：视频音频合并失败，使用原视频\"",
        "      fi",
        "      ",
        "      # 清理临时文件",
        "      rm -f \"$AUDIO_TEMP\" \"$AUDIO_LOOPED\" 2>/dev/null",
        "    else",
        "      echo \"⚠️ 警告：无法创建循环音频，跳过音频处理\"",
        "    fi",
        "  else",
        "    echo \"⚠️ 警告：无法转换音频文件，跳过音频处理\"",
        "  fi",
        "  ",
        "  FINAL_VIDEO=\"$LATEST_VIDEO\"",
        "  echo \"========== 音频处理完成 ==========\"",
        "else",
        "  echo \"未提供附加音频或音频文件不存在，跳过音频处理\"",
        "  echo \"尝试查找的路径:\"",
        "  echo \"  - $AUDIO\"",
        "  echo \"  - /tmp/uploads/$(basename \"$AUDIO\" 2>/dev/null || echo 'N/A')\"",
        "  # 找到最新生成的视频文件（无音频情况）",
        "  FINAL_VIDEO=$(ls -t *.mp4 2>/dev/null | head -n 1)",
        "  if [[ -z \"$FINAL_VIDEO\" ]]; then",
        "    echo \"错误：未找到生成的视频文件\"",
        "    exit 1",
        "  fi",
        "fi",
        "",
        "# 将最终视频保存到固定路径",
        "FINAL_OUTPUT=\"output.mp4\"",
        "mv \"$FINAL_VIDEO\" \"$OUTPUT_DIR/$FINAL_OUTPUT\"",
        "",
        "echo \"✅ 最终视频已保存到: $OUTPUT_DIR/$FINAL_OUTPUT\""
      ]
    },
    {
      "name": "视频高清放大",
      "env_name": "video-High-Quality",
      "required_inputs": ["enable_upscale"],
      "commands": [
        "ENABLE_UPSCALE=\"{enable_upscale}\"",
        "OUTPUT_DIR=\"/tmp/results/video-High-Quality\"",
        "mkdir -p $OUTPUT_DIR",
        "",
        "if [[ \"$ENABLE_UPSCALE\" == \"on\" ]]; then",
        "  echo \"========== 开始执行视频高清放大 ==========\"",
        "  ",
        "  # 检查输入视频是否存在",
        "  INPUT_VIDEO=\"/tmp/results/SkyReels-V2/output.mp4\"",
        "  if [[ ! -f \"$INPUT_VIDEO\" ]]; then",
        "    echo \"错误：未找到输入视频文件: $INPUT_VIDEO\"",
        "    exit 1",
        "  fi",
        "  ",
        "  echo \"输入视频: $INPUT_VIDEO\"",
        "  echo \"输出目录: $OUTPUT_DIR\"",
        "  echo \"放大倍数: {zoom_factor}\"",
        "  ",
        "  # 切换到高清放大工作目录",
        "  cd $HOME/Video-High-Quality/examples/WanVSR",
        "  ",
        "  # 检查工作目录和脚本是否存在",
        "  if [[ ! -f \"infer_flashvsr_v1.1_tiny_long_video.py\" ]]; then",
        "    echo \"错误：未找到高清放大脚本，请检查环境是否已正确安装\"",
        "    exit 1",
        "  fi",
        "  ",
        "  # 执行高清放大",
        "  echo \"开始执行高清放大处理...\"",
        "  python infer_flashvsr_v1.1_tiny_long_video.py \\",
        "    --input \"$INPUT_VIDEO\" \\",
        "    --output \"$OUTPUT_DIR/output.mp4\" \\",
        "    --scale {zoom_factor} \\",
        "    --device cuda \\",
        "    --keep_audio",
        "  ",
        "  # 检查输出文件",
        "  if [[ -f \"$OUTPUT_DIR/output.mp4\" ]]; then",
        "    echo \"✅ 视频高清放大完成: $OUTPUT_DIR/output.mp4\"",
        "  else",
        "    echo \"⚠️ 警告：高清放大可能失败，未找到输出文件\"",
        "    exit 1",
        "  fi",
        "else",
        "  echo \"高清放大已关闭，跳过此步骤\"",
        "fi"
      ]
    },
    {
      "name": "复制高清放大后的视频",
      "env_name": "SkyReels-V2-DF-14B-720P-H100-sync",
      "commands": [
        "ENABLE_UPSCALE=\"{enable_upscale}\"",
        "OUTPUT_DIR=\"/tmp/results/SkyReels-V2\"",
        "mkdir -p $OUTPUT_DIR",
        "",
        "if [[ \"$ENABLE_UPSCALE\" == \"on\" ]]; then",
        "  if [[ -f \"/tmp/results/video-High-Quality/output.mp4\" ]]; then",
        "    # 高清放大后的视频覆盖原视频",
        "    cp \"/tmp/results/video-High-Quality/output.mp4\" \"$OUTPUT_DIR/output.mp4\"",
        "    echo \"✅ 高清放大后的视频已保存到: $OUTPUT_DIR/output.mp4\"",
        "  else",
        "    echo \"⚠️ 警告：未找到高清放大后的视频文件，使用原视频\"",
        "  fi",
        "else",
        "  echo \"高清放大已关闭，使用原视频\"",
        "fi"
      ]
    }
  ],
  "endpoint": "echo \"{server_output_file}\""
}
